rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isLoggedin() {
      return request.auth != null;
    }
    
    // üõ°Ô∏è Fonction s√©curis√©e pour r√©cup√©rer le r√¥le et le statut de l'utilisateur qui fait la requ√™te
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // 1. R√®gles pour la collection "biens"
    match /biens/{bienId} {
      // üí° MODIFICATION : 
      // Tout le monde peut lire si le bien est 'V√©rifi√©'
      // OU si l'utilisateur est admin
      // OU si l'utilisateur est le propri√©taire du bien (pour qu'il voie ses biens "En attente")
      allow read: if resource.data.status == 'V√©rifi√©' || 
                    (isLoggedin() && (getUserData().role == 'admin' || resource.data.proprioId == request.auth.uid));
      
      // üí° MODIFICATION : Seuls les propri√©taires connect√©s, non bloqu√©s ET abonn√©s peuvent cr√©er des biens
      allow create: if isLoggedin() 
                    && getUserData().role == 'proprietaire' 
                    && getUserData().status == 'actif'
                    && getUserData().abonnement.actif == true; 
      
      // üí° MODIFICATION : Seul le propri√©taire du bien ou l'admin peut modifier, si le proprio est actif et abonn√©
      allow update: if isLoggedin() 
                    && getUserData().status == 'actif' 
                    && getUserData().abonnement.actif == true
                    && (getUserData().role == 'admin' || resource.data.proprioId == request.auth.uid);
      
      // Seul l'admin peut supprimer
      allow delete: if isLoggedin() && getUserData().role == 'admin';
    }
    
    // R√®gles pour la collection "properties" (si tu l'utilises toujours)
    match /properties/{propertyId} {
      allow read: if true;
      
      // üí° MODIFICATION : S√©curisation ici aussi
      allow create: if isLoggedin() && getUserData().role == 'proprietaire' && getUserData().status == 'actif' && getUserData().abonnement.actif == true;
      
      allow update, delete: if isLoggedin() && getUserData().status == 'actif' && getUserData().abonnement.actif == true && (getUserData().role == 'admin' || resource.data.ownerId == request.auth.uid);
    }

    // 2. R√®gles pour la collection "users"
    match /users/{userId} {
      // Autorise la lecture pour l'admin ET pour l'utilisateur lui-m√™me
      allow read: if isLoggedin() && (request.auth.uid == userId || getUserData().role == 'admin');
      
      // Permettre la cr√©ation initiale du document user par l'utilisateur lui-m√™me
      allow create: if isLoggedin() && request.auth.uid == userId;
      
      // üí° MODIFICATION : Autorise la mise √† jour pour l'admin ou l'utilisateur lui-m√™me
      // Seul l'admin peut modifier le statut "bloqu√©/actif" ou le plan d'abonnement.
      allow update: if isLoggedin() && (
        request.auth.uid == userId || getUserData().role == 'admin'
      );
    }
  }
}